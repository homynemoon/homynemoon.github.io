<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wedding Photo Mission</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Nanum+Myeongjo:wght@400;700&family=Gowun+Dodum&family=Stylish&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #BEB2A7;
            --primary-color-dark: #A99E94;
            --primary-color-accent: #D2C8BF;
            --primary-color-light-bg: #F5F2EF;
            --font-family: 'Gowun Dodum', sans-serif;
        }
        body {
            font-family: var(--font-family);
            background-color: var(--primary-color-light-bg);
        }
        .bg-primary { background-color: var(--primary-color); }
        .hover\:bg-primary-dark:hover { background-color: var(--primary-color-dark); }
        .text-primary { color: var(--primary-color); }
        .text-primary-accent { color: var(--primary-color-accent); }
        .border-primary { border-color: var(--primary-color); }
        .focus\:ring-primary:focus { --tw-ring-color: var(--primary-color); }
        .focus\:border-primary:focus { border-color: var(--primary-color); }
        .bg-primary-light-bg { background-color: var(--primary-color-light-bg) !important; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 110; left: 50%; bottom: 30px; transform: translateX(-50%); opacity: 0; transition: opacity 0.3s, visibility 0.3s, bottom 0.3s; }
        .toast.show { visibility: visible; opacity: 1; bottom: 50px; }
        .admin-fab { position: fixed; bottom: 20px; right: 20px; z-index: 90; }
        .tab-active { color: var(--primary-color); border-color: var(--primary-color); border-bottom-width: 2px; }
        .tab-inactive { color: #6b7280; }
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid var(--primary-color); /* Blue */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-gray-800">

    <div id="app-container" class="max-w-lg mx-auto min-h-screen bg-white shadow-lg relative">
        
        <!-- Loading Spinner -->
        <div id="loading-overlay" class="absolute inset-0 bg-white/80 z-50 flex flex-col items-center justify-center hidden">
            <div class="loader"></div>
            <p class="mt-4 text-gray-600">처리 중...</p>
        </div>

        <!-- Welcome Screen -->
        <div id="welcome-screen" class="flex flex-col items-center justify-center h-screen p-8 text-center">
            <div id="welcome-icon-container" class="mb-8 w-24 h-24 flex items-center justify-center"></div>
            <h1 id="couple-names" class="text-3xl font-bold text-gray-800 mb-2"></h1>
            <p class="text-lg text-gray-600 mb-8">Wedding Photo Mission</p>
            <p id="welcome-message" class="mb-10"></p>
            <button id="start-btn" class="w-full bg-primary hover:bg-primary-dark text-white font-bold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105">
                참여하기
            </button>
        </div>

        <!-- Main Content (Missions & Gallery) -->
        <div id="main-screen" class="hidden p-4 pb-20">
            <header class="text-center py-4">
                <h1 class="text-2xl font-bold text-primary">Wedding Photo Mission</h1>
                <p id="mission-reward-message" class="text-gray-500 mt-1"></p>
            </header>

            <div class="flex justify-center border-b-2 border-gray-200 mb-4">
                <button id="missions-tab" class="flex-1 py-3 text-center font-semibold tab-active">미션 목록</button>
                <button id="gift-tab" class="flex-1 py-3 text-center font-semibold tab-inactive">포토 기프트</button>
                <button id="gallery-tab" class="flex-1 py-3 text-center font-semibold tab-inactive">실시간 갤러리</button>
            </div>

            <div id="missions-view"><div id="mission-list" class="space-y-3"></div></div>
            <div id="gift-view" class="hidden text-center p-8">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-primary-accent mb-4"><path d="M20 12v4a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h4"></path><path d="m18 5 4 4"></path><path d="m18 9-4-4"></path><path d="M12 12H8v4h4Z"></path><path d="M12 8H8v4h4Z"></path><path d="M16 12h-4v4h4Z"></path></svg>
                <h2 class="text-xl font-bold mb-2">사진 선물하기</h2>
                <p class="text-gray-600 mb-6">미션과 관계없이, 두 사람에게 선물하고 싶은<br>결혼식의 모든 순간을 자유롭게 공유해주세요.</p>
                <button id="gift-upload-btn" class="w-full bg-primary hover:bg-primary-dark text-white font-bold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105">사진 올리기</button>
            </div>
            <div id="gallery-view" class="hidden">
                <div id="gallery-controls" class="hidden p-2 text-center mb-2">
                    <button id="download-all-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">
                        모든 사진 한번에 다운로드 (ZIP)
                    </button>
                </div>
                <p id="gallery-placeholder" class="text-center text-gray-500 py-16">아직 공유된 사진이 없어요.<br>첫 번째 사진을 올려주세요!</p>
                <div id="gallery-grid" class="grid grid-cols-3 gap-1"></div>
            </div>
        </div>
        
        <div id="name-entry-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-white rounded-lg w-full max-w-sm p-6 fade-in">
                <h2 class="text-xl font-bold mb-4">참여하기</h2><p class="text-gray-600 mb-4">사진을 올리실 이름을 입력해주세요.</p>
                <input type="text" id="name-entry-input" placeholder="이름 (예: 김창회)" class="w-full border-gray-300 rounded-md p-2 mb-4 focus:ring-primary focus:border-primary">
                <button id="name-entry-submit-btn" class="w-full bg-primary hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg">입장하기</button>
            </div>
        </div>
        <div id="upload-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-white rounded-lg w-full max-w-sm p-6 fade-in">
                <h2 id="modal-title" class="text-xl font-bold mb-4"></h2>
                <div id="image-preview-container" class="w-full h-32 flex items-center justify-center rounded-md mb-4 border bg-gray-100 overflow-hidden"><p id="image-preview-text" class="text-gray-500"></p></div>
                <div id="message-input-container" class="hidden mb-4">
                     <label for="upload-message" class="block text-sm font-medium text-gray-700">신랑 신부에게 남기는 메시지</label>
                     <textarea id="upload-message" rows="3" placeholder="두 분의 결혼을 축하합니다!" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2"></textarea>
                </div>
                <p class="text-xs text-gray-500 text-center mb-4">혹시 사진 용량이 초과되어 업로드 되지 않는다면,<br>신랑 신부에게 직접 보내주시면 정말 감사드리겠습니다!</p>
                <div class="flex gap-2">
                    <button id="cancel-upload-btn" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">취소</button>
                    <button id="submit-upload-btn" class="w-full bg-primary hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg">사진 올리기</button>
                </div>
            </div>
        </div>
    </div>
    <button id="admin-fab" class="admin-fab bg-purple-600 hover:bg-purple-700 text-white rounded-full p-3 shadow-lg hidden">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h9z"></path><line x1="12" y1="2" x2="12" y2="22"></line></svg>
    </button>
    <div id="admin-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
        <div id="admin-modal-content" class="bg-white rounded-lg w-full max-w-md p-6 fade-in max-h-[90vh] overflow-y-auto">
            <h2 class="text-xl font-bold mb-4 text-purple-600">관리자 설정</h2>
            
            <h3 class="text-lg font-bold mb-3">콘텐츠 설정</h3>
            <div class="mb-4">
                <label for="admin-couple-names" class="block text-sm font-medium text-gray-700">신랑 & 신부 이름</label>
                <input type="text" id="admin-couple-names" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2">
            </div>
            <div class="mb-4">
                <label for="admin-welcome-message" class="block text-sm font-medium text-gray-700">환영 메시지</label>
                <textarea id="admin-welcome-message" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2"></textarea>
            </div>
             <div class="mb-4">
                <label for="admin-reward-message" class="block text-sm font-medium text-gray-700">보상 메시지</label>
                <textarea id="admin-reward-message" rows="2" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2"></textarea>
            </div>
            <hr class="my-6">

            <h3 class="text-lg font-bold mb-3">대표 이미지 설정</h3>
            <div class="flex items-center gap-4 mb-4">
                <div id="admin-image-preview" class="w-16 h-16 bg-gray-100 rounded-md flex items-center justify-center overflow-hidden border">
                </div>
                <div class="flex-grow">
                    <label for="admin-welcome-image" class="block text-sm font-medium text-gray-700">이미지 업로드 (2MB 이하)</label>
                    <input type="file" id="admin-welcome-image" accept="image/*" class="mt-1 text-sm text-gray-600 file:mr-4 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100 cursor-pointer">
                    <button id="admin-remove-image-btn" class="mt-2 text-xs text-red-500 hover:underline">이미지 삭제 (기본 하트로 변경)</button>
                </div>
            </div>
            <hr class="my-6">

            <h3 class="text-lg font-bold mb-3">디자인 설정</h3>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="admin-primary-color" class="block text-sm font-medium text-gray-700">대표 색상</label>
                    <input type="color" id="admin-primary-color" class="mt-1 h-10 block w-full border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label for="admin-font-family" class="block text-sm font-medium text-gray-700">글꼴</label>
                    <select id="admin-font-family" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 h-10">
                        <option value="'Noto Sans KR', sans-serif">Noto Sans KR (기본)</option>
                        <option value="'Nanum Myeongjo', serif">Nanum Myeongjo (명조체)</option>
                        <option value="'Gowun Dodum', sans-serif">Gowun Dodum (손글씨체)</option>
                        <option value="'Stylish', sans-serif">Stylish (스타일리시)</option>
                    </select>
                </div>
            </div>
            <hr class="my-6">

            <h3 class="text-lg font-bold mb-3">미션 관리</h3>
            <div id="admin-mission-list" class="space-y-3"></div>
            <button id="add-mission-btn" class="mt-4 w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">미션 추가하기</button>
            <hr class="my-6">
            
            <div class="flex gap-2 mt-6">
                <button id="admin-cancel-btn" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">취소</button>
                <button id="admin-save-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">변경사항 저장</button>
            </div>
            <button id="admin-reset-btn" class="mt-4 w-full text-sm text-red-500 hover:underline">모든 설정 및 사진 초기화</button>
        </div>
    </div>
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg w-full max-w-sm p-6 fade-in">
            <h2 id="confirm-title" class="text-xl font-bold mb-2"></h2><p id="confirm-message" class="text-gray-600 mb-6"></p>
            <div class="flex gap-2"><button id="confirm-cancel-btn" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">취소</button><button id="confirm-ok-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">확인</button></div>
        </div>
    </div>
    <input type="file" id="photo-upload-input" class="hidden" accept="image/*" multiple><div id="toast-notification" class="toast"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, addDoc, collection, onSnapshot, query, where, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- CONFIG & STATE ---
        const ADMIN_PASSWORD = '1234';
        let db, auth, userId, userName = '', isAdmin = false;
        let currentUploadContext = { type: null, id: null };
        let selectedFiles = [];
        let confirmCallback = null;
        let tempWelcomeImage = null;
        let unsubscribePhotos = null;
        let configRef, photosRef;

        const defaultSiteContent = {
            coupleNames: "김창회 & 김한별", welcomeMessage: "두 사람의 가장 행복한 날,<br>소중한 순간들을 여러분의 시선으로 담아주세요!",
            rewardMessage: "오늘을 평생 기억하게 될 신랑 신부에게 영원한 선물을 전해주세요!", welcomeImage: null,
            theme: { primaryColor: '#BEB2A7', fontFamily: "'Gowun Dodum', sans-serif" },
            missions: [
                { id: 1, title: "신랑 입장", description: "늠름하게 입장하는 신랑의 모습을 담아주세요!" },
                { id: 2, title: "신부 입장", description: "세상에서 가장 아름다운 신부의 입장 순간을 포착해주세요." },
                { id: 3, title: "사랑의 눈맞춤", description: "신랑 신부가 서로를 바라보는 로맨틱한 순간을 담아주세요." },
                { id: 4, title: "두 손 꼭 잡은 모습", description: "두 사람이 손을 꼭 잡고 있는 따뜻한 모습을 찍어주세요." },
                { id: 5, title: "가장 아름다운 둘의 모습", description: "오늘의 주인공, 두 사람의 가장 빛나는 순간을 찍어주세요." },
                { id: 6, title: "신랑&신부의 행복한 미소", description: "두 사람이 가장 환하게 웃는 순간을 포착해주세요!" },
                { id: 7, title: "최고의 축하 리액션!", description: "신랑 신부를 향해 힘껏 박수치거나 환호하는 순간을 남겨주세요!" },
                { id: 8, title: "함께 걷는 첫걸음", description: "함께 걷는 두 사람의 발걸음을 찍어주세요." },
                { id: 9, title: "퇴장", description: "새로운 시작을 향해 행진하는 두 사람의 뒷모습을 축복해주세요." },
                { id: 10, title: "자유 포토! 당신의 시선", description: "당신의 눈에 담긴 결혼식의 어떤 순간이든 자유롭게 공유해주세요." }
            ]
        };
        let siteContent = JSON.parse(JSON.stringify(defaultSiteContent));
        let uploadedPhotos = [];

        const dom = Object.fromEntries(Array.from(document.querySelectorAll('[id]')).map(el => [el.id.replace(/-(\w)/g, (m, p1) => p1.toUpperCase()), el]));

        // --- Functions ---
        const showToast = (message) => { dom.toastNotification.textContent = message; dom.toastNotification.classList.add('show'); setTimeout(() => dom.toastNotification.classList.remove('show'), 3000); };
        const darkenColor = (hex,p) => {let [r,g,b]=hex.match(/\w\w/g).map(x=>parseInt(x,16)),f=1-p/100;r=Math.max(0,Math.floor(r*f));g=Math.max(0,Math.floor(g*f));b=Math.max(0,Math.floor(b*f));return `#${r.toString(16).padStart(2,'0')}${g.toString(16).padStart(2,'0')}${b.toString(16).padStart(2,'0')}`};
        const lightenColor = (hex,p) => {let [r,g,b]=hex.match(/\w\w/g).map(x=>parseInt(x,16)),f=p/100;r=Math.min(255,Math.floor(r+(255-r)*f));g=Math.min(255,Math.floor(g+(255-g)*f));b=Math.min(255,Math.floor(b+(255-b)*f));return `#${r.toString(16).padStart(2,'0')}${g.toString(16).padStart(2,'0')}${b.toString(16).padStart(2,'0')}`};
        const applyTheme = (theme) => { const r=document.documentElement.style;r.setProperty('--primary-color',theme.primaryColor);r.setProperty('--primary-color-dark',darkenColor(theme.primaryColor,10));r.setProperty('--primary-color-accent',lightenColor(theme.primaryColor,15));r.setProperty('--primary-color-light-bg',lightenColor(theme.primaryColor,95));r.setProperty('--font-family',theme.fontFamily);};
        
        const initializeAppContent = async () => {
            try {
                const docSnap = await getDoc(configRef);
                if (docSnap.exists()) {
                    const savedData = docSnap.data();
                    siteContent = {
                        ...defaultSiteContent,
                        ...savedData,
                        theme: { ...defaultSiteContent.theme, ...(savedData.theme || {}) },
                        missions: (Array.isArray(savedData.missions) && savedData.missions.length > 0)
                            ? savedData.missions
                            : defaultSiteContent.missions,
                    };
                } else {
                    await setDoc(configRef, defaultSiteContent);
                }
            } catch (error) { 
                console.error("Error during initial data load:", error);
                showToast("데이터 로딩 중 오류 발생. 기본 설정으로 시작합니다.");
            }
            
            userName = localStorage.getItem('weddingMissionUserName') || '';
            updateUI();
            listenForPhotos();
            dom.loadingOverlay.classList.add('hidden');
            dom.welcomeScreen.classList.remove('hidden');
        };

        const listenForPhotos = () => {
            if (!db) return;
            if (unsubscribePhotos) unsubscribePhotos();
            const q = isAdmin ? query(photosRef) : query(photosRef, where("uploaderId", "==", userId || ''));
            unsubscribePhotos = onSnapshot(q, (snapshot) => {
                uploadedPhotos = snapshot.docs.map(doc => ({...doc.data(), id: doc.id}));
                uploadedPhotos.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
                renderGallery();
                renderMissions();
            }, (error) => console.error("Error listening for photos:", error));
        };
        
        const updateUI = () => { applyTheme(siteContent.theme); renderWelcomeIcon(); dom.coupleNames.innerHTML = siteContent.coupleNames; dom.welcomeMessage.innerHTML = siteContent.welcomeMessage; dom.missionRewardMessage.innerHTML = siteContent.rewardMessage; renderMissions(); renderGallery(); };
        const renderMissions = () => { 
            if (!siteContent.missions) return;
            dom.missionList.innerHTML = ''; 
            siteContent.missions.forEach(m => {
                const photoCount = uploadedPhotos.filter(p => p.type === 'mission' && p.missionId === m.id).length;
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-lg shadow-md border border-gray-200';
                card.innerHTML = `<div class="flex justify-between items-center"><div><h3 class="font-bold text-lg">${m.title}</h3><p class="text-gray-600 text-sm">${m.description}</p></div><div class="text-right"><div class="text-xs text-primary font-semibold mb-1">${photoCount} 장</div><button data-mission-id="${m.id}" class="upload-btn bg-primary-light-bg text-primary hover:bg-primary-dark hover:text-white font-bold py-2 px-3 text-sm transition-colors">올리기</button></div></div>`;
                dom.missionList.appendChild(card);
            });
        };
        const renderGallery = () => { 
            if (isAdmin && uploadedPhotos.length > 0) {
                dom.galleryControls.classList.remove('hidden');
            } else {
                dom.galleryControls.classList.add('hidden');
            }

            if (uploadedPhotos.length === 0) {
                dom.galleryPlaceholder.classList.remove('hidden');
                dom.galleryGrid.classList.add('hidden');
            } else {
                dom.galleryPlaceholder.classList.add('hidden');
                dom.galleryGrid.classList.remove('hidden');
                dom.galleryGrid.innerHTML = '';
                uploadedPhotos.forEach(p => {
                    const container = document.createElement('div');
                    container.className = 'aspect-square bg-gray-200';
                    const img = document.createElement('img');
                    img.src = p.data;
                    img.className = 'w-full h-full object-cover';
                    container.appendChild(img);
                    dom.galleryGrid.appendChild(container);
                });
            }
        };
        const renderWelcomeIcon = () => {
            dom.welcomeIconContainer.innerHTML = '';
            if (siteContent.welcomeImage) {
                const img = document.createElement('img');
                img.src = siteContent.welcomeImage;
                img.className = 'w-full h-full object-cover rounded-full shadow-md';
                dom.welcomeIconContainer.appendChild(img);
            } else {
                const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                svg.setAttribute('width', '64');
                svg.setAttribute('height', '64');
                svg.setAttribute('viewBox', '0 0 24 24');
                svg.setAttribute('fill', 'none');
                svg.setAttribute('stroke', 'currentColor');
                svg.setAttribute('stroke-width', '2');
                svg.setAttribute('stroke-linecap', 'round');
                svg.setAttribute('stroke-linejoin', 'round');
                svg.setAttribute('class', 'text-primary-accent');
                
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', 'M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z');
                svg.appendChild(path);
                
                dom.welcomeIconContainer.appendChild(svg);
            }
        };
        const switchTab = (tab) => {
            [{btn:dom.missionsTab,view:dom.missionsView},{btn:dom.giftTab,view:dom.giftView},{btn:dom.galleryTab,view:dom.galleryView}].forEach(p=>{p.btn.classList.replace('tab-active','tab-inactive');p.view.classList.add('hidden')});
            dom[tab+'Tab'].classList.replace('tab-inactive','tab-active');
            dom[tab+'View'].classList.remove('hidden');
        };
        const openUploadModal = (type, id=null) => {
            currentUploadContext = {type, id};
            selectedFiles = [];
            dom.uploadMessage.value = '';
            dom.imagePreviewText.textContent = '사진을 선택해주세요';
            const previewImg = dom.imagePreviewContainer.querySelector('img');
            if (previewImg) previewImg.remove();
            
            if (type === 'mission') {
                const mission = siteContent.missions.find(m => m.id === id);
                dom.modalTitle.textContent = `"${mission.title}" 미션`;
                dom.messageInputContainer.classList.add('hidden');
            } else {
                dom.modalTitle.textContent = '포토 기프트 올리기';
                dom.messageInputContainer.classList.remove('hidden');
            }
            dom.uploadModal.classList.remove('hidden');
        };
        const handleFileUpload = async (files) => {
            if (files.length === 0) return;
            selectedFiles = Array.from(files);
            dom.imagePreviewText.textContent = `${selectedFiles.length}개의 사진 선택됨`;
            const previewImg = dom.imagePreviewContainer.querySelector('img');
            if (previewImg) previewImg.remove();
            
            const reader = new FileReader();
            reader.onload = e => {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'w-full h-full object-contain';
                dom.imagePreviewContainer.appendChild(img);
                dom.imagePreviewText.textContent = '';
            };
            reader.readAsDataURL(selectedFiles[0]);
        };
        const readFileAsDataURL = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
        const showConfirm = (title, message, callback) => {
            dom.confirmTitle.textContent = title;
            dom.confirmMessage.innerHTML = message;
            confirmCallback = callback;
            dom.confirmModal.classList.remove('hidden');
        };

        const renderAdminImagePreview = () => {
            dom.adminImagePreview.innerHTML = '';
            if (tempWelcomeImage) {
                const img = document.createElement('img');
                img.src = tempWelcomeImage;
                img.className = 'w-full h-full object-cover';
                dom.adminImagePreview.appendChild(img);
            } else {
                const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                svg.setAttribute('width', '32');
                svg.setAttribute('height', '32');
                svg.setAttribute('viewBox', '0 0 24 24');
                svg.setAttribute('fill', 'none');
                svg.setAttribute('stroke', 'currentColor');
                svg.setAttribute('stroke-width', '2');
                svg.setAttribute('stroke-linecap', 'round');
                svg.setAttribute('stroke-linejoin', 'round');
                svg.setAttribute('class', 'text-gray-400');

                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', 'M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z');
                svg.appendChild(path);

                dom.adminImagePreview.appendChild(svg);
            }
        };

        const renderAdminMissions = (missions) => {
            dom.adminMissionList.innerHTML = '';
            missions.forEach(mission => {
                const missionItem = document.createElement('div');
                missionItem.className = 'flex items-center gap-2 p-2 border rounded-md';
                missionItem.innerHTML = `
                    <div class="flex-grow">
                        <input type="text" value="${mission.title}" data-id="${mission.id}" data-field="title" class="admin-mission-input w-full p-1 border-b" placeholder="미션 제목">
                        <input type="text" value="${mission.description}" data-id="${mission.id}" data-field="description" class="admin-mission-input w-full p-1 text-sm text-gray-600" placeholder="미션 설명">
                    </div>
                    <button data-id="${mission.id}" class="remove-mission-btn text-red-500 hover:text-red-700">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    </button>
                `;
                dom.adminMissionList.appendChild(missionItem);
            });
        };

        const openAdminModal = () => {
            dom.adminCoupleNames.value = siteContent.coupleNames;
            dom.adminWelcomeMessage.value = siteContent.welcomeMessage.replace(/<br>/g, '\n');
            dom.adminRewardMessage.value = siteContent.rewardMessage.replace(/<br>/g, '\n');
            tempWelcomeImage = siteContent.welcomeImage;
            renderAdminImagePreview();
            dom.adminPrimaryColor.value = siteContent.theme.primaryColor;
            dom.adminFontFamily.value = siteContent.theme.fontFamily;
            renderAdminMissions(siteContent.missions);
            dom.adminModal.classList.remove('hidden');
        };
        
        // --- Event Listeners ---
        dom.startBtn.addEventListener('click',()=>{if(userName){dom.welcomeScreen.classList.add('hidden');dom.mainScreen.classList.remove('hidden');dom.mainScreen.classList.add('fade-in')}else{dom.nameEntryModal.classList.remove('hidden')}});
        dom.nameEntrySubmitBtn.addEventListener('click',()=>{const n=dom.nameEntryInput.value.trim();if(!n)return showToast('이름을 입력해주세요.');userName=n;localStorage.setItem('weddingMissionUserName',userName);dom.nameEntryModal.classList.add('hidden');dom.welcomeScreen.classList.add('hidden');dom.mainScreen.classList.remove('hidden');dom.mainScreen.classList.add('fade-in')});
        dom.missionsTab.addEventListener('click',()=>switchTab('missions'));dom.giftTab.addEventListener('click',()=>switchTab('gift'));dom.galleryTab.addEventListener('click',()=>switchTab('gallery'));
        dom.missionList.addEventListener('click',e=>{const b=e.target.closest('.upload-btn');if(b){const i=parseInt(b.dataset.missionId);openUploadModal('mission',i);dom.photoUploadInput.click()}});
        dom.giftUploadBtn.addEventListener('click',()=>{openUploadModal('gift');dom.photoUploadInput.click()});
        dom.photoUploadInput.addEventListener('change',e=>handleFileUpload(e.target.files));
        dom.cancelUploadBtn.addEventListener('click',()=>dom.uploadModal.classList.add('hidden'));
        dom.submitUploadBtn.addEventListener('click',async()=>{if(!userName)return showToast('오류 발생. 새로고침 해주세요.');if(selectedFiles.length===0)return showToast('사진을 선택해주세요.');dom.submitUploadBtn.disabled=true;dom.submitUploadBtn.textContent='업로드 중...';for(const f of selectedFiles){try{const d=await readFileAsDataURL(f),p={uploader:userName,uploaderId:userId,data:d,type:currentUploadContext.type,missionId:currentUploadContext.id,timestamp:new Date().toISOString()};if(p.type==='gift')p.message=dom.uploadMessage.value.trim();await addDoc(photosRef,p)}catch(e){showToast("사진 업로드 중 오류 발생")}};dom.uploadModal.classList.add('hidden');showToast(`${selectedFiles.length}장의 사진이 업로드되었습니다!`);switchTab('gallery');dom.submitUploadBtn.disabled=false;dom.submitUploadBtn.textContent='사진 올리기'});
        
        dom.downloadAllBtn.addEventListener('click', () => {
            if (uploadedPhotos.length === 0) {
                showToast('다운로드할 사진이 없습니다.');
                return;
            }

            showToast('사진 압축을 시작합니다... (잠시만 기다려주세요)');
            dom.downloadAllBtn.disabled = true;
            dom.downloadAllBtn.textContent = '압축 중...';

            const zip = new JSZip();
            uploadedPhotos.forEach(photo => {
                const base64Data = photo.data.split(',')[1];
                const fileName = `${new Date(photo.timestamp).toISOString().split('.')[0].replace(/[-:T]/g, '')}_${photo.uploader}.jpg`;
                zip.file(fileName, base64Data, {base64: true});
            });

            zip.generateAsync({type:"blob"})
                .then(function(content) {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(content);
                    link.download = `wedding_photos_${new Date().toISOString().split('T')[0]}.zip`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    showToast('다운로드가 시작되었습니다.');
                    dom.downloadAllBtn.disabled = false;
                    dom.downloadAllBtn.textContent = '모든 사진 한번에 다운로드 (ZIP)';
                });
        });

        // Admin Listeners
        dom.adminFab.addEventListener('click', openAdminModal);
        dom.adminCancelBtn.addEventListener('click', () => dom.adminModal.classList.add('hidden'));
        dom.adminWelcomeImage.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 2 * 1024 * 1024) return showToast('이미지 크기는 2MB를 초과할 수 없습니다.');
                tempWelcomeImage = await readFileAsDataURL(file);
                renderAdminImagePreview();
            }
        });
        dom.adminRemoveImageBtn.addEventListener('click', () => { tempWelcomeImage = null; renderAdminImagePreview(); });
        dom.addMissionBtn.addEventListener('click', () => {
            const newId = siteContent.missions.length > 0 ? Math.max(...siteContent.missions.map(m => m.id)) + 1 : 1;
            siteContent.missions.push({ id: newId, title: "", description: "" });
            renderAdminMissions(siteContent.missions);
        });
        dom.adminModalContent.addEventListener('click', (e) => {
            const btn = e.target.closest('.remove-mission-btn');
            if (btn) {
                const idToRemove = parseInt(btn.dataset.id);
                siteContent.missions = siteContent.missions.filter(m => m.id !== idToRemove);
                renderAdminMissions(siteContent.missions);
            }
        });
        dom.adminSaveBtn.addEventListener('click', async () => {
            const newConfig = {
                ...siteContent,
                coupleNames: dom.adminCoupleNames.value,
                welcomeMessage: dom.adminWelcomeMessage.value.replace(/\n/g, '<br>'),
                rewardMessage: dom.adminRewardMessage.value.replace(/\n/g, '<br>'),
                welcomeImage: tempWelcomeImage,
                theme: {
                    primaryColor: dom.adminPrimaryColor.value,
                    fontFamily: dom.adminFontFamily.value,
                },
                missions: Array.from(dom.adminMissionList.children).map(item => {
                    const titleInput = item.querySelector('[data-field="title"]');
                    const descInput = item.querySelector('[data-field="description"]');
                    return {
                        id: parseInt(titleInput.dataset.id),
                        title: titleInput.value,
                        description: descInput.value
                    };
                })
            };
            try {
                await setDoc(configRef, newConfig);
                siteContent = newConfig;
                updateUI();
                dom.adminModal.classList.add('hidden');
                showToast('설정이 저장되었습니다.');
            } catch (error) {
                showToast('저장 중 오류가 발생했습니다.');
                console.error("Error saving config:", error);
            }
        });
        dom.adminResetBtn.addEventListener('click', () => showConfirm('모든 데이터 초기화','정말로 모든 설정과 업로드된 사진을 초기화하시겠습니까?<br><strong>이 작업은 되돌릴 수 없습니다.</strong>',async()=>{try{const photoSnapshot=await getDocs(photosRef);const deletePromises=photoSnapshot.docs.map(d=>deleteDoc(d.ref));deletePromises.push(deleteDoc(configRef));await Promise.all(deletePromises);showToast('모든 데이터가 초기화되었습니다.');setTimeout(()=>window.location.reload(),1000)}catch(e){showToast('초기화 중 오류 발생')}}));
        dom.confirmCancelBtn.addEventListener('click',()=>dom.confirmModal.classList.add('hidden'));
        dom.confirmOkBtn.addEventListener('click',()=>{if(confirmCallback)confirmCallback();dom.confirmModal.classList.add('hidden')});
        
        const checkAdminMode=()=>{if(window.location.hash==='#admin'){const p=prompt('관리자 비밀번호:','');if(p===ADMIN_PASSWORD){isAdmin=true;dom.adminFab.classList.remove('hidden');showToast('관리자 모드 활성화');listenForPhotos()}else if(p)alert('비밀번호 오류');history.pushState("",document.title,window.location.pathname+window.location.search)}};
        
        // --- App Initialization ---
        const startApp = async () => {
            // Immediately show the UI with default content, don't wait for Firebase
            updateUI(); 
            dom.loadingOverlay.classList.remove('hidden');

            try {
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-wedding-app';
                configRef = doc(db, `/artifacts/${appId}/public/data/config`, "main");
                photosRef = collection(db, `/artifacts/${appId}/public/data/photos`);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        await initializeAppContent();
                        checkAdminMode();
                    } else {
                        const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                        if (token) { await signInWithCustomToken(auth, token); }
                        else { await signInAnonymously(auth); }
                    }
                });
            } catch(e) {
                console.error("Firebase initialization failed:", e);
                dom.loadingOverlay.innerHTML = "<p>연결에 실패했습니다. 기본 설정으로 표시됩니다.</p>";
                setTimeout(() => {
                    dom.loadingOverlay.classList.add('hidden');
                    dom.welcomeScreen.classList.remove('hidden');
                }, 2000);
            }
        };

        startApp();

    </script>
</body>
</html>

